

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head th:replace="common/header :: common_head(~{::title},~{},~{::link},~{})">
    <title th:text="'个人中心_'+${application.website.name}"></title>
    <link rel="stylesheet" href="/css/user.css"/>
</head>
<body class="">

<div th:replace="common/top :: top('')">
</div>
<div class="main box_center cf">
    <div class="userBox cf">
        <div class="my_l">

            <ul class="log_list">
                <li><a class="link_1 on" href="/user/userinfo.html">个人中心</a></li>
                <li><a class="link_4" href="/user/favorites.html">我的书架</a></li>
                <li><a class="link_6" href="/user/comment.html">我的书评</a></li>
                <li><a class="link_7 " href="/user/feedback_list.html">我的反馈</a></li>
                <li><a class="link_8 " href="/user/setup.html">账号设置</a></li>
            </ul>

        </div>
        <div class="my_r">
            <div class="my_info cf">
                <img id="imgLogo" class="user_big_head" src="/images/man.png" />
                <div class="my_info_txt">
                    <p class="my_name" id="my_name">
                        </p>
                    <ul class="my_list">
                        <li class="my_blockchain_address"><i>区块链地址：</i><em class="red" id="blockchain_address"></em></li>
                        <li class="my_blockchain_height"><i>区块链高度：</i><em class="red" id="blockchain_height">0</em><a class="btn_link" href="javascript:getBlockchainHeight()" >更新</a></li>
                        <li class="my_account_balance"><i>账户余额：</i><em class="red" id="accountBalance">0</em>通证<!--<em class="red">+</em><em class="red">0</em>代金券--><a href="/pay/index.html" class="btn_link">立即充值</a></li>
                        <li class="my_account_chainbalance"><i>链上余额：</i><em class="red" id="accountBalanceOnChain">0</em><a class="btn_link" href="javascript:getAccountBalance()" >更新</a></li>
                        <li class="my_token_name"><i>通证名称：</i><em class="red" id="token_name">0</em><a class="btn_link" href="javascript:getTokenName()" >更新</a></li>
                        <li class="my_token_balance"><i>通证余额：</i><em class="red" id="token_balance">0</em><a class="btn_link" href="javascript:getTokenBalance()" >更新</a></li>
                        <li class="my_gold"><i>通证充值：</i><em class="red" id="tx_hash">0x</em><a class="btn_link" href="javascript:payWithBlockchain()" >充值</a></li>

                    </ul>
                </div>
            </div>
            <div class="my_bookshelf">
                <div class="title cf">
                    <h4 class="fl">
                        我的书架</h4>
                    <a href="/user/favorites.html" class="fr">全部收藏 &gt;</a>
                </div>
                <div class="updateTable">
                    <table cellpadding="0" cellspacing="0">
                        <thead>
                        <tr>
                            <th class="style">
                                类别
                            </th>
                            <th class="name">
                                书名
                            </th>
                            <th class="chapter">
                                最新章节
                            </th>
                            <th class="time">
                                更新时间
                            </th>
                            <th class="goread">
                                书签
                            </th>
                        </tr>
                        </thead>
                        <tbody id="bookShelfList">


                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="common/footer :: footer">
</div>
<div th:replace="common/js :: js"></div>
<script type="text/javascript" src="/javascript/user.js"></script>
<script type="text/javascript">
    //网页开始时候加载区块链信息
    //For testnet use only
    inTokenAddress="0xf2f4eec6c2adfcf780aae828de0b25f86506ffae";
    inTestAddress="0xa8863fc8ce3816411378685223c03daae9770ebb";//0x968ddf25855f55306f3aa24973d73709d8c743a6
    getBlockchainHeight();

    //查询用户信息
    $.ajax({
        type: "get",
        url: "/user/userInfo",
        data: {},
        dataType: "json",
        success: function (data) {
            if (data.code == 200) {
                if(data.data.userPhoto){
                    $("#imgLogo").attr("src",data.data.userPhoto);
                }
                if(data.data.nickName){
                    $("#my_name").html(data.data.nickName);
                }else{
                    $("#my_name").html(data.data.username);
                }

                 //
                $("#blockchain_address").html(data.data.blockchainAddress);
                $("#accountBalance").html(data.data.accountBalance);

            } else if (data.code == 1001) {
                //未登录
                location.href = '/user/login.html?originUrl=' + decodeURIComponent(location.href);

            } else {
                layer.alert(data.msg);
            }

        },
        error: function () {
            layer.alert('网络异常');
        }
    })

    //查询书架列表
    $.ajax({
        type: "get",
        url: "/user/listBookShelfByPage",
        data: {'limit':2},
        dataType: "json",
        success: function (data) {
            if (data.code == 200) {
                var bookShelfList = data.data.list;
                if (bookShelfList.length > 0) {
                    var bookShelfListHtml = "";
                    for (var i = 0; i < bookShelfList.length; i++) {
                        var book = bookShelfList[i];
                        bookShelfListHtml += (" <tr class=\"book_list\" vals=\"291\">\n" +
                            "                            <td class=\"style bookclass\">\n" +
                            "                                <a href=\"/book/bookclass.html?c="+book.catId+"\" >[" + book.catName + "]</a>\n" +
                            "                            </td>\n" +
                            "                            <td class=\"name\">\n" +
                            "                                <a href=\"/book/" + book.bookId + ".html\">\n" +
                            "                                    " + book.bookName + "</a>\n" +
                            "                            </td>\n" +
                            "                            <td class=\"chapter\" valsc=\"291|2037554|1\">\n" +
                            "<a href='/book/" + book.bookId + "/" + book.lastIndexId + ".html'>" + book.lastIndexName + "</a>" +
                            "                            </td>\n" +
                            "                            <td class=\"time\">\n" +
                            "                                " + book.lastIndexUpdateTime + "\n" +
                            "                            </td>\n" +
                            "                            <td class=\"goread\">\n" +
                            "<a href='/book/" + book.bookId + "/" + book.preContentId + ".html'>继续阅读</a>" +
                            "                            </td>\n" +
                            "                        </tr>");
                    }
                    $("#bookShelfList").html(bookShelfListHtml);
                }

            } else {
                layer.alert(data.msg);
            }

        },
        error: function () {
            layer.alert('网络异常');
        }
    })

    // Access the blockchain to get the highest block
    // test purpose, set the news in the news_controller
    function getBlockchainHeight(){
        $.ajax({
            type: "GET",
            url: "/contract/listBlockchainHeight",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                  $("#blockchain_height").html(data.data);
console.log("data.data:", data.data);

                } else if(data.code == 1001){
                    //未登录
                    location.href = '/user/login.html?originUrl='+decodeURIComponent(location.href);

                }else {
                    layer.alert(data.msg);
                }

            },
            error: function () {
                layer.alert('网络异常');
            }
        })

    }

    // 使用web3j直接对接区块链后台，显示用户原生通证余额
    function getAccountBalance(){
        $.ajax({
            type: "GET",
            url: "/user/getAccountBalance",
            data: {'accountAddress':inTestAddress},
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                  $("#accountBalanceOnChain").html(data.data);
console.log("data.data:", data.data);

                } else if(data.code == 1001){
                    //未登录
                    location.href = '/user/login.html?originUrl='+decodeURIComponent(location.href);

                }else {
                    layer.alert(data.msg);
                }

            },
            error: function () {
                layer.alert('网络异常');
            }
        })

    }

    // 使用web3j直接对接区块链后台，显示通证名称
    function getTokenName(){
        $.ajax({
            type: "GET",
            url: "/contract/getTokenName",
            data: {'tokenAddress':inTokenAddress},
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                  $("#token_name").html(data.data);
console.log("data.data:", data.data);

                } else if(data.code == 1001){
                    //未登录
                    location.href = '/user/login.html?originUrl='+decodeURIComponent(location.href);

                }else {
                    layer.alert(data.msg);
                }

            },
            error: function () {
                layer.alert('网络异常');
            }
        })

    }

    // 使用web3j直接对接区块链后台，显示用户原生通证余额
    function getTokenBalance(){
        $.ajax({
            type: "GET",
            url: "/contract/getTokenBalance",
            data: {'tokenAddress':inTokenAddress, 'accountAddress':inTestAddress},
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                  $("#token_balance").html(data.data);
console.log("data.data:", data.data);

                } else if(data.code == 1001){
                    //未登录
                    location.href = '/user/login.html?originUrl='+decodeURIComponent(location.href);

                }else {
                    layer.alert(data.msg);
                }

            },
            error: function () {
                layer.alert('网络异常');
            }
        })

    }

    // 使用web3j直接对接区块链后台，测试原生通证交易
    // 向原账户地址发送0.1个测试币
    function payWithBlockchain() {
    var toAddress = $("#blockchain_address").val();
    console.log("toAddress:",toAddress);
        $.ajax({
            type: "POST",
            url: "/user/payWithBlockchain",
            data: {'toAddress': inTestAddress, 'value': 0.01},
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    $("#tx_hash").html(data.data);
                    //显示交易HASH
                    console.log("payWithBlockchain.data:", data.data);
                    console.log("ID:", toAddress);
                } else if (data.code == 1001) {
                    //未登录
                    location.href = '/user/login.html?originUrl=' + decodeURIComponent(location.href);

                } else {
                    layer.alert(data.msg);
                }

            },
            error: function () {
                layer.alert('网络异常');
            }
        })

    }
</script>
</body>
</html>
